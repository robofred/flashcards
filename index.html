<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Detection with OpenCV.js</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #container {
            position: relative;
            display: inline-block;
        }
        canvas {
            border: 2px solid #333;
            max-width: 100%;
        }
        #direction {
            position: absolute;
            top: 10px;
            left: 10px;
            color: green;
            font-size: 20px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>Motion Detection</h1>
    <p>Move left or right in front of your camera!</p>
    <div id="container">
        <canvas id="canvasOutput"></canvas>
        <div id="direction"></div>
    </div>

    <!-- Load OpenCV.js from CDN -->
    <script src="https://docs.opencv.org/4.5.2/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

    <script type="text/javascript">
        let video;
        let prevFrame = null;
        let prevCenter = null;

        // Wait for OpenCV.js to load
        function onOpenCvReady() {
            console.log('OpenCV.js is ready');
            startCamera();
        }

        // Start the webcam feed
        function startCamera() {
            video = document.createElement('video');
            video.width = 640;
            video.height = 480;
            video.autoplay = true;

            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    processVideo();
                })
                .catch(err => {
                    console.error("Error accessing webcam: ", err);
                    alert("Could not access webcam. Please allow camera permissions.");
                });
        }

        // Process video frames
        function processVideo() {
            let canvas = document.getElementById('canvasOutput');
            let ctx = canvas.getContext('2d');
            canvas.width = video.width;
            canvas.height = video.height;

            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let gray = new cv.Mat();
            let thresh = new cv.Mat();

            function detectMotion() {
                // Capture frame from video
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                src.data.set(ctx.getImageData(0, 0, canvas.width, canvas.height).data);

                // Convert to grayscale and blur
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, gray, new cv.Size(21, 21), 0);

                if (prevFrame === null) {
                    prevFrame = gray.clone();
                    requestAnimationFrame(detectMotion);
                    return;
                }

                // Frame differencing
                cv.absdiff(prevFrame, gray, thresh);
                cv.threshold(thresh, thresh, 30, 255, cv.THRESH_BINARY);
                cv.dilate(thresh, thresh, new cv.Mat(), new cv.Point(-1, -1), 2);

                // Find contours
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let direction = "";
                if (contours.size() > 0) {
                    // Get largest contour
                    let maxContour = contours.get(0);
                    for (let i = 1; i < contours.size(); i++) {
                        if (cv.contourArea(contours.get(i)) > cv.contourArea(maxContour)) {
                            maxContour = contours.get(i);
                        }
                    }

                    if (cv.contourArea(maxContour) > 500) {
                        // Calculate center of mass
                        let moments = cv.moments(maxContour);
                        let centerX = moments.m10 / moments.m00;
                        let centerY = moments.m01 / moments.m00;

                        // Draw bounding rect and center
                        let rect = cv.boundingRect(maxContour);
                        cv.rectangle(src, new cv.Point(rect.x, rect.y), 
                                     new cv.Point(rect.x + rect.width, rect.y + rect.height), 
                                     [0, 255, 0, 255], 2);
                        cv.circle(src, new cv.Point(centerX, centerY), 5, [0, 0, 255, 255], -1);

                        // Detect direction
                        if (prevCenter !== null) {
                            if (centerX < prevCenter[0] - 10) {
                                direction = "Moving Left";
                            } else if (centerX > prevCenter[0] + 10) {
                                direction = "Moving Right";
                            }
                        }
                        prevCenter = [centerX, centerY];
                    }
                }

                // Display direction
                document.getElementById('direction').innerText = direction;

                // Show processed frame
                cv.imshow('canvasOutput', src);

                // Update previous frame
                prevFrame.delete();
                prevFrame = gray.clone();

                // Clean up
                contours.delete();
                hierarchy.delete();

                requestAnimationFrame(detectMotion);
            }

            requestAnimationFrame(detectMotion);

            // Clean up on exit
            window.onunload = () => {
                src.delete();
                gray.delete();
                thresh.delete();
                if (prevFrame) prevFrame.delete();
            };
        }
    </script>
</body>
</html>
